---
title: "Replicating Hayley's RTS,S & SMC report results"
author: "Hillary Topazian"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    theme: lumen
    highlight: tango
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
---
  
```{r setup, message=FALSE, warning=FALSE}
# packages
library(tidyverse)
library(fuzzyjoin)
library(cowplot)
library(plotly)
library(kableExtra)
library(malariasimulation)

library(patchwork)
library(scales)
library(LaCroixColoR)

# devtools::install_github('mrc-ide/malariasimulation@dev', force=TRUE)
# devtools::install_github('johannesbjork/LaCroixColoR')
knitr::opts_knit$set(message=FALSE, warning=FALSE)
```

```{css style settings, echo = FALSE}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 12px;
    border-left: 5px solid #eee;
}
```

<br>

# Set-up

Our goal here is to compare model outputs from `malariasimulation` to `MalariaLanchR`, and to replicate Hayley's findings from her report.  

I have checked - 

  * **Seasonality**
    + High seasonality - g0 = 0.284596, g = c(-0.317878, -0.0017527, 0.116455), h = c(-0.331361, 0.293128, -0.0617547)
    + Low seasonality - g0 = 0.285505, g = c(-0.325352, -0.0109352, 0.0779865), h = c(-0.132815, 0.104675, -0.013919)
    + Seasonal intervention efficacy starts at 4 months for seasonal settings and 6 months for highly seasonal settings.
  
  * **Human population** = 100,000
  
  * **Warmup** = 4 years for malariasimulation to stabilize at EIR equilibrium
  
  * **Simulation length** = 15 years
  
  * **Species** = 25% arabiensis, 25% funestus, 50% gambiae. Bednet and indoor parameters checked and match. No info for IRS parameters since intervention is not turned on.
  
  * **Treatment** 
    + drug = AL
    + drug_efficacy = 0.95000
    + drug_rel_c = 0.05094
    + drug_prophylaxis_shape = 11.30000
    + drug_prophylaxis_scale = 10.60000
    + coverage = 0.45
  
  * **RTS,S** 
    + boosters: given 12 months after dose 3 (booster 1) and 24 months after dose 3 (booster 2)
    + booster coverage = 0.80
    + boosted antibody mean and stdev = 5.56277, 0.35 
    + updated antibody mean and stdev = 6.37008, 0.35 (and synergy)
    + for synergy model: rtss_vmax = 0.911028, rtss_alpha = 0.75303, rtss_beta = 62.8525
   
  * **SMC**
    + drug = SP-AQ
    + drug_efficacy = 0.75
    + drug_rel_c = 0.32
    + drug_prophylaxis_shape = 3.67 (modified from default)
    + drug_prophylaxis_scale = 41.48 (modified from default)
    + coverage = 0.75
    + min-age = 3 months
    + max-age = 5 years
    + synergy drug_prophylaxis_shape = 2.955348
    + synergy drug_prophylaxis_scale = 58.99686
    + 4 monthly rounds, with timing based on seasonality cuves
    
  * **Outcomes**
    + Unless otherwise stated events averted are calculated relative to a baseline no-vaccination scenario
    + incidence calculated among individuals 0-100 years
    + severe malaria enabled

<br>

# Link Pf prev 2-10 to EIR

`MalariaLanchR` accepts PfPR<sub>2-10</sub> values as inputs to set the model at an equilibrium value. But `malariasimulation` only accepts EIR value inputs using the function `set_equilibrium()`. We will use a range of `malariaEquilibrium` outputs to back link PfPR<sub>2-10</sub> values to EIR outputs using `fuzzyjoin`.

``` {r prevmatch, message=FALSE, warning=FALSE}
# create vector of eirs
eir <- seq(from = .1, to = 40, by=.1)
eq_params <- malariaEquilibrium::load_parameter_set("Jamie_parameters.rds")

# calculate prevalence between 2:10 for a bunch of EIRs
prev <- vapply(
  eir,
  function(eir) {
    eq <- malariaEquilibrium::human_equilibrium(
      eir,
      ft=0,
      p=eq_params,
      age=0:100
    )
    sum(eq$states[2:10, 'pos_M']) / sum(eq$states[2:10, 'prop'])
  },
  numeric(1)
)

prevmatch <- as_tibble(cbind(eir,prev))

# Pre-intervention baseline PfPR2-10 starting at values 10, 25, 35, 55 
PfPR <- as_tibble_col(c(.10, .25, .35, .55), column_name="pfpr")

# Hayley's baseline PfPR2-10 range: 3%, 5%, 10%, 15%, 20%, 25%, 35%, 45%, 55%, 65%
match <- PfPR %>%
  fuzzyjoin::difference_left_join(prevmatch, by=c("pfpr"="prev"), 
    max_dist=1, distance_col="dist") %>%
  group_by(pfpr) %>% slice_min(dist)

```

Our EIR values are 0.9, 3.6, 6.8, 21.9.

<br>

# Figure 1

From Hayley's report:

> Figure 1 Cumulative clinical cases averted over 15 years as a function of baseline PfPR2-10  (four settings representative of medium to high transmission intensity are shown) and seasonality A&C) per population and B&D) per 100,000 fully vaccinated children. Coverage is fixed at 80% for the first three doses with a 20% drop off (from the 3rd dose) for the fourth and fifth doses (coverage is the same for the 4th and 5th dose). Fully vaccinated children are defined as those receiving the primary series (first three doses). EPI- is the four-dose age-based strategy, SV 4&5-dose is the seasonal strategy assuming the original vaccine efficacy profile from the Phase 3 RTS,S trials, SV 4&5-dose – updated booster is the seasonal strategy assuming the updated higher efficacy against infection for the 4th and 5th dose based on our validation to the seasonal malaria vaccination Phase 3b clinical trial (Annex 1).  

<br>

## MalariaLaunchR

```{r Figure1MalariaLaunchR, message=FALSE, warning=FALSE, fig.width=12, fig.height=7}
impact <- readRDS('C:/Users/htopazia/OneDrive - Imperial College London/Github/Hayley_report/Part_1/impact_costs_all_ages.RDS')

#-New facet label names for sease variables--
seas.labs <- c("Highly Seasonal", "Seasonal")
names(seas.labs) <- c("highly_seasonal", "seasonal")

figure_2_pd <- 
  impact %>%
  filter(coverage == 0.8, cost_per_dose == 6.52, delivery_cost == 1.62) %>% 
  filter(pfpr %in% c(0.1,0.25,0.35,0.55))

#-per population---------------------------- 
ca <-  
  ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = cases_averted, fill=run)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear"), 
                    labels=c("epi" = "EPI",
                             "srtss_4_dose_original" = "SV 4-dose",
                             "srtss_5_dose_original" = "SV 5-dose",
                             "srtss_4_dose_update" = "SV 4-dose - updated booster",
                             "srtss_5_dose_update" = "SV 5-dose - updated booster"))+
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("A - Clinical cases averted per 100,000 population") +
  theme_bw( ) 


#-per 100,000 fully vaccinated people----------
ca_fvp <- 
  ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = cases_averted_per_100000_fvp, fill=run)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear"), 
                    labels=c("epi" = "EPI",
                             "srtss_4_dose_original" = "SV 4-dose",
                             "srtss_5_dose_original" = "SV 5-dose",
                             "srtss_4_dose_update" = "SV 4-dose - updated booster",
                             "srtss_5_dose_update" = "SV 5-dose - updated booster"))+
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
 # ylab("Clinical cases averted\n(per 100,000 fully vaccinated children)") +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("B - Clinical cases averted (per 100,000 fully vaccinated children)") +
  theme_bw( )

#-deaths averted per population--------------
da <-  
  ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = deaths_averted, fill=run)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear"), 
                    labels=c("epi" = "EPI",
                             "srtss_4_dose_original" = "SV 4-dose",
                             "srtss_5_dose_original" = "SV 5-dose",
                             "srtss_4_dose_update" = "SV 4-dose - updated booster",
                             "srtss_5_dose_update" = "SV 5-dose - updated booster"))+
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("C - Deaths averted per 100,000 population") +
  theme_bw( )

#-deaths averted per 100,000 fully vaccinated-------
da_fvp <- 
  ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = deaths_averted_per_100000_fvp, fill=run)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear"), 
                    labels=c("epi" = "EPI",
                             "srtss_4_dose_original" = "SV 4-dose",
                             "srtss_5_dose_original" = "SV 5-dose",
                             "srtss_4_dose_update" = "SV 4-dose - updated booster",
                             "srtss_5_dose_update" = "SV 5-dose - updated booster"))+
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("D - Deaths averted (per 100,000 fully vaccinated children)") +
  theme_bw( )

#-combining outputs into single figure
main_fig <- ca + ca_fvp + da + da_fvp + plot_layout(guides = "collect") & theme(legend.position = "bottom") 

main_fig

# ggsave("combined_averted.png", main_fig, width=12, height = 7)

```

## malariasimulation

```{r Figure1malariasimulation, message=FALSE, warning=FALSE, fig.width=12, fig.height=7}
output <- readRDS('C:/Users/htopazia/OneDrive - Imperial College London/Github/rtss_malariasimulation/rds/rtss_smc_averted.rds')

fig1dat <- output %>% 
  left_join(match %>% select(pfpr, eir)) %>% 
  mutate(pfpr = ifelse(is.na(pfpr), .55, pfpr)) %>%
  filter(!grepl('SMC',intervention))

seas.labs <- c("Highly Seasonal", "Seasonal")
names(seas.labs) <- c("high seasonality", "low seasonality")

# cases averted per 100,000 population  
Fig1a <-  
  ggplot(fig1dat, aes(x = factor(pfpr * 100), y = cases_averted, fill=intervention)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear")) +
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("A - Clinical cases averted per 100,000 population") +
  theme_bw() 
 
# cases averted per 100,000 vaccinated children
Fig1b <- 
  ggplot(fig1dat, aes(x = factor(pfpr * 100), y = cases_averted_per_100000_fvp, fill=intervention)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear")) +
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("B - Clinical cases averted (per 100,000 fully vaccinated children)") +
  theme_bw()

# deaths averted per 100,000 population
Fig1c <-  
  ggplot(fig1dat, aes(x = factor(pfpr * 100), y = deaths_averted, fill=intervention)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear")) +
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("C - Deaths averted per 100,000 population") +
  theme_bw() 
  
# deaths averted per 100,000 vaccinated children
Fig1d <- 
  ggplot(fig1dat, aes(x = factor(pfpr * 100), y = deaths_averted_per_100000_fvp, fill=intervention)) +
  geom_hline(yintercept = 0) +
  geom_bar(position=position_dodge(), stat="identity",colour="black") +
  scale_fill_manual(values=lacroix_palette("PeachPear")) +
  labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
       y = " ",
       fill="Vaccination schedule",
       parse=TRUE) + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
  xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
  ggtitle("D - Deaths averted (per 100,000 fully vaccinated children)") +
  theme_bw()

# combining outputs into single figure
main_fig <- Fig1a + Fig1b + Fig1c + Fig1d + plot_layout(guides = "collect") & theme(legend.position = "bottom")

main_fig

# ggsave("./plots/combined_averted.png", main_fig, width=12, height = 7)

```

<br>

# Figure 2

From Hayley's report:

> Figure 2 Cumulative clinical cases and deaths averted over 15 years per population as a function of baseline PfPR2-10 (four representative of medium to high transmission intensity are shown) and seasonality. Coverage is fixed at 80% for the first three doses with a 20% drop off for the fourth and fifth doses. SMC coverage at 75%. EPI- is the four-dose age-based strategy, SV 4&5-dose is the seasonal strategy assuming the original vaccine efficacy profile for the Phase 3 RTS,S trials. SV 4&5-dose – updated booster is the seasonal strategy assuming the updated higher efficacy against infection for the 4th and 5th dose and synergy the increase in the modelled total RTS,S and SMC efficacy against infection above that of each intervention when they are considered alone based on the seasonal malaria vaccination Phase 3b clinical trial.

<br>

## MalariaLaunchR

```{r Figure2MalariaLaunchR, message=FALSE, warning=FALSE, fig.width=8, fig.height=5}
impact <- readRDS('C:/Users/htopazia/OneDrive - Imperial College London/Github/Hayley_report/Part_2/impact_costs_all_ages.RDS')

figure_2_pd <- 
  impact %>%
  filter(coverage %in% c(0.8,0), cost_per_dose == 6.52, delivery_cost == 1.62) %>% 
  filter(pfpr %in% c(0.1,0.25,0.35,0.55))

# New facet label names for supp variable
seas.labs <- c("Highly Seasonal", "Seasonal")
names(seas.labs) <- c("highly_seasonal", "seasonal")

figure_2_pd$run <- factor(figure_2_pd$run, levels=c("smc", "epi_smc","srtss_4_dose_original_smc", "srtss_4_dose_update_smc",  "srtss_4_dose_param_mod_smc", "srtss_5_dose_original_smc", "srtss_5_dose_update_smc", "srtss_5_dose_param_mod_smc"))

# set the colour levels 
color_vals <- c("smc" = "#f0c9e9",
                "epi_smc" = "#FF3200",
                "srtss_4_dose_original_smc" = "#E9A17C", 
                "srtss_4_dose_update_smc" = "#E9E4A6", 
                "srtss_4_dose_param_mod_smc" = "#eab06d",
                "srtss_5_dose_original_smc" = "#1bb6af", 
                "srtss_5_dose_update_smc" = "#0076bb",
                "srtss_5_dose_param_mod_smc" = "#172869")

labels <- c("epi_smc" = "EPI + SMC", 
            "srtss_4_dose_original_smc" = "SV 4-dose + SMC",
            "srtss_5_dose_original_smc" = "SV 5-dose + SMC",
            "srtss_4_dose_update_smc" = "SV 4-dose - updated booster + SMC",
            "srtss_5_dose_update_smc" = "SV 5-dose - updated booster + SMC", 
            "srtss_4_dose_param_mod_smc" = "SV 4-dose synergy + SMC", 
            "srtss_5_dose_param_mod_smc" = "SV 5-dose synergy + SMC", 
            "smc" = "SMC alone")

#-plot impact averted-----------------------
ca <-  
    ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = cases_averted, fill=run)) +
    geom_hline(yintercept = 0) +
    geom_bar(position=position_dodge(), stat="identity",colour="black") +
    scale_fill_manual(values = color_vals, 
                      labels = labels) + 
    labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
         y = " ",
         fill="Vaccination schedule",
         parse=TRUE) + 
    scale_y_continuous(labels = comma) + 
    facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
    xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
    ggtitle("A - Clinical cases averted per 100,000 population") +
    theme_bw( ) 

da <-  
    ggplot(figure_2_pd, aes(x = factor(pfpr * 100), y = deaths_averted, fill=run)) +
    geom_hline(yintercept = 0) +
    geom_bar(position=position_dodge(), stat="identity",colour="black") +
    scale_fill_manual(values = color_vals, 
                      labels = labels) + 
    labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
         y = " ",
         fill="Vaccination schedule",
         parse=TRUE) + 
    scale_y_continuous(labels = comma) + 
    facet_wrap(seasonality  ~ ., labeller = labeller(seasonality = seas.labs)) +
    xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
    ggtitle("B - Deaths averted per 100,000 population") +
    theme_bw()
 
report_fig <- ca / da + plot_layout(guides = "collect") & theme(legend.position = "right")
  
report_fig
  
# ggsave("report_fig_main.png", report_fig)#, width=8, height = 5)

```

## malariasimulation

```{r Figure2malariasimulation, message=FALSE, warning=FALSE, fig.width=8, fig.height=5}
fig2dat <- output %>% 
  left_join(match %>% select(pfpr, eir)) %>% 
  mutate(pfpr = ifelse(is.na(pfpr), .55, pfpr)) %>%
  filter(grepl('SMC',intervention))

seas.labs <- c("Highly Seasonal", "Seasonal")
names(seas.labs) <- c("high seasonality", "low seasonality")

# set the colour levels 
color_vals <- c("SMC alone" = "#f0c9e9",
                "EPI + SMC" = "#FF3200",
                "SV 4-dose + SMC" = "#E9A17C", 
                "SV 4-dose - updated booster + SMC" = "#E9E4A6", 
                "SV 4-dose synergy + SMC" = "#eab06d",
                "SV 5-dose + SMC" = "#1bb6af", 
                "SV 5-dose - updated booster + SMC" = "#0076bb",
                "SV 5-dose synergy + SMC" = "#172869")

fig2dat$intervention <- factor(fig2dat$intervention, levels=c("SMC alone", "EPI + SMC", "SV 4-dose + SMC", "SV 4-dose - updated booster + SMC", "SV 4-dose synergy + SMC", "SV 5-dose + SMC", "SV 5-dose - updated booster + SMC", "SV 5-dose synergy + SMC"))

labels <- c("SMC alone", "EPI + SMC", "SV 4-dose + SMC", "SV 4-dose - updated booster + SMC", "SV 4-dose synergy + SMC", "SV 5-dose + SMC", "SV 5-dose - updated booster + SMC", "SV 5-dose synergy + SMC")

#-plot impact averted-----------------------
Fig2a <-  
    ggplot(fig2dat, aes(x = factor(pfpr * 100), y = cases_averted, fill=intervention)) +
    geom_hline(yintercept = 0) +
    geom_bar(position=position_dodge(), stat="identity",colour="black") +
    scale_fill_manual(values = color_vals, 
                      labels = labels) + 
    labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
         y = " ",
         fill="Vaccination schedule",
         parse=TRUE) + 
    scale_y_continuous(labels = comma) + 
    facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
    xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
    ggtitle("A - Clinical cases averted per 100,000 population") +
    theme_bw( ) 

Fig2b <-  
    ggplot(fig2dat, aes(x = factor(pfpr * 100), y = deaths_averted, fill=intervention)) +
    geom_hline(yintercept = 0) +
    geom_bar(position=position_dodge(), stat="identity",colour="black") +
    scale_fill_manual(values = color_vals, 
                      labels = labels) + 
    labs(x = expression(paste(italic(Pf),"PR"[2-10])), 
         y = " ",
         fill="Vaccination schedule",
         parse=TRUE) + 
    scale_y_continuous(labels = comma) + 
    facet_wrap(season  ~ ., labeller = labeller(season = seas.labs)) +
    xlab(expression(italic(PfPR[2-10]~(symbol("\045"))))) +
    ggtitle("B - Deaths averted per 100,000 population") +
    theme_bw()
 
report_fig <- Fig2a / Fig2b + plot_layout(guides = "collect") & theme(legend.position = "right")
  
report_fig
```

<br>

# Comparison table

Comparing the differences in case and death counts between MalariaLaunchR and malariasimulation outputs. 

  * **case difference** = # cases new model - # cases old model
  * **case %** = ^ as %
  * **death difference** = # deaths new model - # cases deaths model
  * **death %**	= ^ as %
  * **vacc difference**	= # vaccinated kids new model - # vaccinated kids  old model
  * **vacc %** = ^ as %

```{r table1malariasimulation, message=FALSE, warning=FALSE, results="asis"}
A <- readRDS('C:/Users/htopazia/OneDrive - Imperial College London/Github/Hayley_report/Part_1/impact_costs_all_ages.RDS') 

B <- readRDS('C:/Users/htopazia/OneDrive - Imperial College London/Github/Hayley_report/Part_2/impact_costs_all_ages.RDS')

C <- A %>% full_join(B) %>%
  filter(coverage %in% c(0,0.8), cost_per_dose == 6.52, delivery_cost == 1.62) %>% 
  filter(pfpr %in% c(0.1,0.25,0.35,0.55)) %>% 
  mutate(intervention = case_when(run=="epi" ~ "EPI",
      run=="srtss_4_dose_original" ~ "SV 4-dose",
      run=="srtss_5_dose_original" ~ "SV 5-dose",
      run=="srtss_4_dose_update" ~ "SV 4-dose - updated booster",
      run=="srtss_5_dose_update" ~ "SV 5-dose - updated booster",
      run=="epi_smc" ~ "EPI + SMC", 
      run=="srtss_4_dose_original_smc" ~ "SV 4-dose + SMC",
      run=="srtss_5_dose_original_smc" ~ "SV 5-dose + SMC",
      run=="srtss_4_dose_update_smc" ~ "SV 4-dose - updated booster + SMC",
      run=="srtss_5_dose_update_smc" ~ "SV 5-dose - updated booster + SMC", 
      run=="srtss_4_dose_param_mod_smc" ~ "SV 4-dose synergy + SMC", 
      run=="srtss_5_dose_param_mod_smc" ~ "SV 5-dose synergy + SMC",
      run=="smc" ~ "SMC alone")) %>%
   select(intervention, pfpr, seasonality, cases, deaths, cases_averted, deaths_averted, cases_averted_per_100000_fvp, number_fvp) 

D <- output %>% ungroup() %>%
  left_join(match %>% select(pfpr, eir)) %>% 
  mutate(pfpr = ifelse(is.na(pfpr), .55, pfpr)) %>%
  mutate(seasonality = 
           case_when(season=='high seasonality'~'highly_seasonal',
                     season=='low seasonality'~'seasonal'),
         number_fvp = dosecomplete) %>%
  select(intervention, pfpr, seasonality, cases, deaths, cases_averted, deaths_averted, cases_averted_per_100000_fvp, number_fvp) %>%
  rename(cases2=cases, deaths2=deaths, ca=cases_averted, da=deaths_averted, cafvp=cases_averted_per_100000_fvp, nfvp=number_fvp)

tabledat <- C %>% full_join(D)

tablefun <- function(data, season, title){
  table <- data %>% filter(seasonality==season) %>% 
  group_by(intervention, pfpr) %>% 
  summarize(case_diff=cases2-cases,
            case_per=case_diff/cases*100,
            deaths_diff=deaths2-deaths,
            deaths_per=deaths_diff/deaths*100,
            nv_diff=nfvp-number_fvp,
            nv_per=nv_diff/number_fvp*100) %>%
  kbl(col.names = c('intervention','PfPR','case difference', 'case %', 'death difference', 'death %', 'vacc difference', 'vacc %'), digits=2, caption = title, escape = F, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", fixed_thread = T))
  
  print(table)
}

tablefun(tabledat,'highly_seasonal',"High Seasonality")
tablefun(tabledat,'seasonal',"Low Seasonality")
```

<br>

# Seasonality

Hayley's report says the interventions should be given out 'in the three months preceding the transmission season'. It appears that this is month 4 for seasonal settings and month 6 for highly seasonal settings.  
                                 
For `malariasimulation` RTS,S dose #3 efficacy starts at month 4 for seasonal settings and month 6 for highly seasonal settings. SMC is spaced so that it covers the high transmission season. RTS,S is shown in blue and SMC in red below. 
                      
<br>

## malariasimulation

```{r seasonalitymalariasimulation, message=FALSE, warning=FALSE, fig.width=5, fig.height=4}
human_population <- 1000
year <- 365
month <- year/12
warmup <- 4*year
sim_length <- 1*year
  
# highly seasonal parameters
high_seas <- get_parameters(list(
  human_population = human_population,
  model_seasonality = TRUE, 
  g0 = 0.284596, 
  g = c(-0.317878, -0.0017527, 0.116455),
  h = c(-0.331361, 0.293128, -0.0617547),
  incidence_rendering_min_ages = 0,
  incidence_rendering_max_ages = 100 * year,
  severe_enabled = T))

# seasonal parameters
low_seas <- get_parameters(list(
  human_population = human_population,
  model_seasonality = TRUE, 
  g0 = 0.285505, 
  g = c(-0.325352, -0.0109352, 0.0779865),
  h = c(-0.132815, 0.104675, -0.013919),
  incidence_rendering_min_ages = 0,
  incidence_rendering_max_ages = 100 * year,
  severe_enabled = T))

# run model
params <- high_seas
params <- set_equilibrium(params, 10)
output_highseas <- run_simulation(warmup + sim_length, params)

params <- low_seas
params <- set_equilibrium(params, 10)
output_lowseas <- run_simulation(warmup + sim_length, params)

plotfun <- function(data,title){
  data %>% 
  mutate(timestep = timestep - warmup) %>% filter(timestep > 0) %>%
  mutate(month=floor(timestep/(365/12))) %>%
  group_by(month) %>%
  summarize(inc_month=sum(n_inc_0_36500 / n_0_36500, na.rm=T)) %>%
ggplot() + 
  geom_line(aes(x=month, y=inc_month)) + 
  labs(title=title,
       x="Timesteps (month)",
       y="Monthly clinical incidence") + 
  scale_y_continuous(limits=c(0,1.7),breaks=c(0,0.5,1,1.5)) +
  theme_classic()
}

first_highseas <- c((peak_season_offset(high_seas)/month) + c(-1.55,-1.5,-0.5,0.5,1.5)) %>% 
  as_tibble() %>%
  mutate(color = c(rep('blue',1), rep('red',4)),
         type = c(rep('RTS,S',1), rep('SMC',4)))

first_lowseas <- c((peak_season_offset(low_seas)/month) + c(-3.5,-1.5,-0.5,0.5,1.5)) %>% 
  as_tibble() %>%
  mutate(color = c(rep('blue',1), rep('red',4)),
         type = c(rep('RTS,S',1), rep('SMC',4)))

A <- plotfun(output_highseas,"highly seasonal") + 
  geom_vline(xintercept=first_highseas$value, lty=2, color=first_highseas$color) +
  geom_rect(xmin = 6.094521, xmax = 9.094521 + 1, ymin = 0, ymax = 1, fill="red", alpha = 0.02)

B <- plotfun(output_lowseas,"seasonal") + 
  geom_vline(xintercept=first_lowseas$value, lty=2, color=first_lowseas$color) +
  geom_rect(xmin = 6.028767, xmax = 9.028767 + 1, ymin = 0, ymax = 1, fill="red", alpha = 0.02)

A + B 
```

<br>

# Things to check

  * MalariaLaunchR uses a constant population size and demography based on the life table for Butajira, Ethiopia, with an average life expectancy at birth of 46.6 years. I don't think malariasimulation has the capacity to plug in demographies yet?

  * Report states that 'events averted are presented as the cumulative number of events averted over a 15-year period following the introduction of vaccine dose 3.' In malariasimulation I am summing events over the entire 15-year simulation length. 
  
  * Deaths - re: Hayley parameters for calculating deaths from severe disease are the following. Check with malariasimulation calculations.
  
    + tx = 0.52 #treatment coverage run in simulations
    + scaler = 0.215 #severe case to death modifier
    + treatment_scaler = 0.5 #treatment modifier
    + treatment_coverage = 0.52 #coverage
    + mort = (1-(treatment_scaler * 0)) * scaler * sev)
    
  * SMC rounds - Hayley ran 3 rounds, but it was supposed to be 4, she will send an updated rds file
